# This playbook is meant to be an all-in-one
- name: Run the ostree update in a single play without external deps
  become: true
  hosts: localhost
  vars:
    conf_file_path: /etc/ostree/remotes.d/rhel-edge.conf
    update_number: "1000"
    repo_url: "http://cert.localhost:3000/api/edge/v1/storage/update-repos/1000"
    repo_content_url: "http://cert.localhost:3000/api/edge/v1/storage/update-repos/1000"
    ostree_remote_name: "remote-name"
    ostree_changes_refs: "false"
    os_tree_ref: "rhel/8/x86_64/edge"
    ostree_gpg_verify: "false"
    ostree_gpg_keypath: "/etc/pki/rpm-gpg/"
    insights_signature_exclude: "/vars/insights_signature,/vars/update_number,/vars/ostree_remote_name,/vars/ostree_changes_refs,/vars/os_tree_ref,/vars/repo_url,/vars/repo_content_url,/vars/ostree_gpg_verify"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldrTkhPR0k0ZG5jMU9FUXJhalZ3VGtGUmFGWklaeTgzUW1GM09U
      RjJibmd6Y2tRM2VrOW5kemxPZWprM1lWSXZhSEJIY0U5U2N6QUtORk01ZVRGcFZqbEVTVk00VkVO
      SWIxSnBhbkJXTVZWMmJqWlVaMkZhV21KeE0zQnlURzQ0TXpRNFUzVmlVekoyVERCRk9WVnBjWE5s
      VDFrd2ExUkRPQXBOS3pKVUt5dFNPRlV3TTNOa1RrbFllWFpwV1ZVM01tczRlazFtU0hsMkszVnZX
      bFZWWmxJMlVITjJNSEppUkRWdFFUY3JWM2RHYmpCaVpIaG1RbGxaQ2twR01USkVNM3BXWm1ORFdH
      eFNjSE5yU0VWUWJXcG9RV041V0dKcWFrOVJZVXc0YlVjMWJsRnNUakJWZGxSUFVsTjBkVFYxUWxs
      cWNGZGFhVUZsTTNVS2JEVkdNR2RrUVc1b1pqSkNaelZaVmtKM1ZrWnpSWFUwZUc5Q1VHdzRORWwy
      YTFKU1lrMTVjRTR2YVVaa01rMURUMkpEU0ROU1ZraDRTR2RFTUhaYVlRcGlOR013Y0dsSlluRklO
      V2xYVVVsWFYxcEJTV1p6UkVKWVZHaGxRbXN4YmxWVU1HaGhWbmhaYlhsWmJsWnRZbVpoY0VwTFYw
      eFRPVmh2ZEc1Q2VYRTVDalUzUVhJMVkzVmxOMjVTWWxSa1ZYbFBTRFIyVjNoM1MxUTRZMk5ZUWxo
      RFRWUnFNMk4wUkdaVFJHdElOMnRDVEZaUEwwRldjalpWV21wTVdpczJWVTBLZGtJd1Myb3hhR2Rv
      VlRoTlN6Y3ZaVlJvVWpCWVpFcHZjemxuVDNkNFoySlBlV3BrTW1OSVYyeEZLeTlqTW5GUmIwWjFT
      MVozUTJNclVISXdRVGh6VGdvcmNVbHJURFZuWjBreVpqUkJRV1psY2pBeVRtdHNkRTFaTm13NFVD
      OVdaSE50VkRWSGJ6Tm1NVUU1WWs1c2JTOXZSVTh2ZVZWbUswcGlWa2hHWm1sR0NreHhVa1JaVVZS
      dldVWmFVa2RsTURSek0zRkJUMnB0YzNWeldYWndTVWt4VHk5WGRXZFhkbVlyUldndlIxSTVjRkZv
      VlhCTVdFNUhTVmRMWlVGamJEY0tZVXhOTTNneU1YTjNTWFpLYTFwcGNGTnlabFJaYUdkRVFVUTVW
      MVV6ZEM5UVpFVTJOM0EyWTNnNVFrRnFUWEF4YUZsV1VETlNUMk5NUXpORUswdFlNd3B6WW14T05X
      eGxXSEJQYXowS1BYRkJWVlVLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: verify that configuration file exist
      ansible.builtin.file:
        path: "{{ conf_file_path }}"
        state: touch
    - name: verify that title of configuration file exist
      ansible.builtin.lineinfile:
        dest: "{{ conf_file_path }}"
        regexp: ^\[.*\]
        line: '[remote "{{ ostree_remote_name }}"]'
        state: present
    - name: apply templated ostree remote config
      ansible.builtin.lineinfile:
        dest: "{{ conf_file_path }}"
        regexp: "^{{ item.property }}"
        line: "{{ item.property }}{{ item.value }}"
        state: present
        loop:
          - { property: 'url=', value: '{{repo_url}}' }
          - { property: 'gpg-verify=', value: '{{ ostree_gpg_verify }}' }
          - { property: 'gpgkeypath=', value: '{{ ostree_gpg_keypath }}' }
          - { property: 'contenturl=', value: '{{ repo_content_url }}' }
          - { property: 'tls-client-key-path=', value: '/etc/pki/consumer/key.pem' }
          - { property: 'tls-client-cert-path=', value: '/etc/pki/consumer/cert.pem' }
    - name: run rpmostree update
      when: not ostree_changes_refs|bool
      ansible.builtin.shell: rpm-ostree upgrade --allow-downgrade
      register: rpmostree_upgrade_out
      changed_when: '"No upgrade available" not in rpmostree_upgrade_out.stdout'
      failed_when: 'rpmostree_upgrade_out.rc != 0'
    - name: run rpmostree rebase
      when: ostree_changes_refs|bool
      ansible.builtin.shell: rpm-ostree rebase "{{ os_tree_ref }}"
      register: rpmostree_rebase_out
      changed_when: '"No upgrade available" not in rpmostree_rebase_out.stdout'
      failed_when: 'rpmostree_rebase_out.rc != 0'
    - name: schedule reboot when rpmostree upgraded
      ansible.builtin.shell: systemd-run --on-active=5 /usr/bin/systemctl reboot
      when: ('rpmostree_rebase_out.changed | "Staging deployment...done" in rpmostree_rebase_out.out') or ('rpmostree_upgrade_out.changed | "Staging deployment...done" in rpmostree_upgrade_out.stdout')
